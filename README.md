é£ğŸ“– ğŸ”— https://h1nj7u0kkda.feishu.cn/docx/XwsDdJt2UoSyamxS8kfcWlisnud?from=from_copylink

# æ•´ä½“æ¶æ„

![img](https://h1nj7u0kkda.feishu.cn/space/api/box/stream/download/asynccode/?code=NjNiZDkwNjY4YzhlM2RhZjVhNDUyZmU1MjNmMzc1NjdfcXQwVXFsMHFyTFhtUG9nbHlKNlRMaXREenpUNnp6TXBfVG9rZW46TEVmUmJ2UFExb0FQSnV4R0t4NWNkaTUxbmhkXzE3MzM1NTc0NDY6MTczMzU2MTA0Nl9WNA)



# æ ¸å¿ƒæµç¨‹

### åŸºæœ¬è¦æ±‚

- å•ç‹¬å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹å»ç›‘æ§æ¯ä¸ªå®ä¾‹çš„å¥åº·çŠ¶å†µ
- æ¯ä¸ªå®ä¾‹æœ€å¤šåŒæ—¶è¿è¡Œ 50 ä¸ªè¿›ç¨‹
- æ¯ä¸ª Docker æœåŠ¡å™¨è¿è¡Œ 1 ä¸ªå®ä¾‹
- å½“é¡¹ç›®å¯åŠ¨æ—¶ï¼Œé»˜è®¤å¼€å¯ä¸€ä¸ª Docker æœåŠ¡å™¨çš„å…¨éƒ¨å®ä¾‹
- å¯ä»¥å¿«é€Ÿçš„è·å–è´Ÿè½½æœ€å°çš„å®ä¾‹

Nacos Redis ä¼šä½œä¸ºæ•°æ®ä¸­å¿ƒï¼Œå­˜å‚¨æ¯ä¸ªå®ä¾‹çš„åœ°å€ï¼Œè´Ÿè½½ä¿¡æ¯å’Œè¿è¡ŒçŠ¶å†µ

### ç›‘æ§çš„å®ç°

å•ç‹¬çš„æœåŠ¡å®ä¾‹ä¼šç»™æ¯ä¸ªå®ä¾‹å‘é€ä¸€ä¸ªæ‰§è¡Œè¾“å‡º Hello World çš„å‘½ä»¤

å¦‚æœè¶…æ—¶æˆ–è€…è¿”å›é”™è¯¯åˆ™è®¤ä¸ºå®ä¾‹å¼‚å¸¸ï¼Œæé«˜è¯¥å®ä¾‹çš„è®°å½•è´Ÿè½½é‡ï¼Œæš‚æ—¶ä¸è®©è¿™ä¸ªå®ä¾‹è¢«ç»§ç»­é€‰æ‹©

å®šæ—¶å»ç›‘æ§è¿™äº›å¼‚å¸¸çš„å®ä¾‹ï¼Œåœ¨å“åº”æ­£å¸¸çš„æƒ…å†µä¸‹å†æ¬¡ç»™å®ä¾‹ä¸Šçº¿

ï¼ï¼ç°åœ¨çš„ç›‘æ§èŠ‚ç‚¹æ˜¯å•æœºï¼Œå¯èƒ½å­˜åœ¨ç½‘ç»œæ‹¥å¡çš„é—®é¢˜

![img](https://h1nj7u0kkda.feishu.cn/space/api/box/stream/download/asynccode/?code=YWZjZTk4MzQxZjQ1MzNlMTdmNWY1NDlmNDNhZWYzMWJfY3p5U3pRYUE1a0plN1ptanFLWEhuV3JQaEpTdHd5ZGNfVG9rZW46WHVsZmJzU29Yb01BYkd4Q1JwZWNqUmdjblNjXzE3MzM1NTc0NDY6MTczMzU2MTA0Nl9WNA)



### è´Ÿè½½å‡è¡¡å®ç°

å½“å‰é‡‡ç”¨ç›‘æ§é›†ç¾¤ java è¿›ç¨‹æ•°é‡çš„æ–¹å¼å»è¿›è¡Œè´Ÿè½½å‡è¡¡

é‡‡ç”¨ Redis çš„ sorted_set æ–¹å¼å»å­˜å‚¨

member-å®ä¾‹ ID

score-è¿è¡Œç”¨æˆ·ä»£ç çš„è¿›ç¨‹æ•°

![img](https://h1nj7u0kkda.feishu.cn/space/api/box/stream/download/asynccode/?code=ZWFjYzIzMjljZTczMjcxNzhjMjc0NzYwZTdjOWM5ZDVfa1NPeEZsS21uVkgwOFBhYkIyT2w4MGw3SEdobWI0VVVfVG9rZW46Um1IcWJhT2Vab28xQmF4TjZMWWNZMmh1bnlnXzE3MzM1NTc0NDY6MTczMzU2MTA0Nl9WNA)



## æäº¤é¢˜ç›®æ•°æ®æµ

![img](https://h1nj7u0kkda.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTFkM2QzNmQzYTA4YjA5OTJjMzY0ZDk1NGI3NTM5YmZfU1lWUXc5UXV2T25oalBRRE5BQmV1VDBDbmVUUEk2SVdfVG9rZW46TGpvcWJJMXdXbzViTXJ4Z0VOdWNpZ2pkbjFnXzE3MzM1NTc0NDY6MTczMzU2MTA0Nl9WNA)



# æ•°æ®åº“è¡¨

## User

```SQL
DROP TABLE IF EXISTS t_user;
CREATE TABLE t_user
(
    `id`            BIGINT COMMENT "é¢˜ç›® ID",
    `user_account`  VARCHAR(16)  NOT NULL COMMENT "è´¦å·",
    `user_avatar`   VARCHAR(512) NOT NULL DEFAULT '' COMMENT "å¤´åƒç½‘ç»œåœ°å€",
    `user_name`     VARCHAR(16)  NOT NULL DEFAULT '' COMMENT "ç”¨æˆ·å",
    `user_password` CHAR(32)     NOT NULL COMMENT "ç”¨æˆ·å¯†ç ",
    `user_role`     VARCHAR(8)   NOT NULL COMMENT "ç”¨æˆ·è§’è‰²",
    `create_time`   DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT "åˆ›å»ºæ—¶é—´",
    `update_time`   DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT "æ›´æ–°æ—¶é—´",
    `is_delete`     TINYINT      NOT NULL DEFAULT 0 COMMENT "é€»è¾‘åˆ é™¤ 1 åˆ é™¤ 0 æœªåˆ é™¤",
    primary key (id),
    unique index user_account_password_unique_index (user_account, user_password)
) COMMENT "ç”¨æˆ·è¡¨";
```

## Question

```SQL
DROP TABLE IF EXISTS t_question;
CREATE TABLE t_question
(
    `id`                BIGINT COMMENT "é¢˜ç›® ID",
    `user_id`           BIGINT       NOT NULL COMMENT "åˆ›å»ºé¢˜ç›®çš„ç”¨æˆ· ID",
    `title`             VARCHAR(32)  NOT NULL COMMENT "é¢˜ç›®æ ‡é¢˜",
    `tags`              VARCHAR(128) NOT NULL DEFAULT '[]' COMMENT "é¢˜ç›®æ ‡ç­¾",
    `content`           TEXT         NOT NULL COMMENT "é¢˜ç›®å†…å®¹",
    `judge_case`        TEXT         NOT NULL COMMENT "è¿è¡Œæµ‹è¯•æ¡ˆä¾‹",
    `core_code`         TEXT         NOT NULL COMMENT "è¿è¡Œæ ¡éªŒä»£ç ",
    `judge_config`      VARCHAR(128) NOT NULL COMMENT "é¢˜ç›®è¿è¡Œèµ„æºé™åˆ¶ æ—¶é—´ ms å†…å­˜ KB",
    `submission_number` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT "ç­”æ¡ˆæäº¤æ•°",
    `acceptance_number` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT "ç­”æ¡ˆæäº¤é€šè¿‡æ•°",
    `create_time`       DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT "åˆ›å»ºæ—¶é—´",
    `update_time`       DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT "æ›´æ–°æ—¶é—´",
    `is_delete`         TINYINT      NOT NULL DEFAULT 0 COMMENT "é€»è¾‘åˆ é™¤ 1 åˆ é™¤ 0 æœªåˆ é™¤",
    primary key (id),
    index user_title_index (user_id, title)
) COMMENT "é¢˜ç›®è¡¨";
```

## AnswerSubmission

```SQL
DROP TABLE IF EXISTS t_answer_submission;
CREATE TABLE t_answer_submission
(
    `id`             BIGINT COMMENT "ç­”æ¡ˆæäº¤ ID",
    `user_id`        BIGINT     NOT NULL COMMENT "åˆ›å»ºç­”æ¡ˆæäº¤çš„ç”¨æˆ· ID",
    `question_id`    BIGINT     NOT NULL COMMENT "é¢˜ç›® ID",
    `submitted_code` TEXT       NOT NULL COMMENT "æäº¤çš„ä»£ç ",
    `judge_info`     TEXT COMMENT "ç­”æ¡ˆæäº¤çš„æµ‹è¯•å¤„ç†ç»“æœ",
    `language`       VARCHAR(8) NOT NULL COMMENT "æäº¤çš„ä»£ç çš„è¯­è¨€",
    `status`         TINYINT    NOT NULL DEFAULT 2 COMMENT "ç­”æ¡ˆæäº¤çš„çŠ¶æ€ 0 å¼‚å¸¸ 1 é€šè¿‡ 2 è¿è¡Œä¸­",
    `create_time`    DATETIME   NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT "åˆ›å»ºæ—¶é—´",
    `update_time`    DATETIME   NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT "æ›´æ–°æ—¶é—´",
    `is_delete`      TINYINT    NOT NULL DEFAULT 0 COMMENT "é€»è¾‘åˆ é™¤ 1 åˆ é™¤ 0 æœªåˆ é™¤",
    primary key (id),
    index user_question_index (user_id, question_id),
    index question_index (question_id)
) COMMENT "ç­”æ¡ˆæäº¤è¡¨";
```

# API æ¥å£

## ç”¨æˆ·

### æ³¨å†Œç”¨æˆ·

```JavaScript
method: 'POST',
url: '/api/user/add'

userAccount?: string;
userAvatar?: string;
userName?: string;
userRole?: string;
```

### è·å–ç”¨æˆ·ä¿¡æ¯

```JavaScript
method: 'GET',
url: '/api/user/get/login'
```

### ç”¨æˆ·ç™»å½•

```JavaScript
method: 'POST',
url: '/api/user/login'

userAccount?: string;
userPassword?: string;
```

## é¢˜ç›®

### æ–°å¢é¢˜ç›®

```JavaScript
method: 'POST',
url: '/api/question/add'

{
    answer?: string;
    content?: string;
    judgeCase?: Array<JudgeCase>;
    judgeConfig?: JudgeConfig;
    tags?: Array<string>;
    title?: string;
};
```

### åˆ é™¤é¢˜ç›®

```JavaScript
method: 'POST',
url: '/api/question/delete'

{
    id?: number;
};
```

### æ›´æ–°é¢˜ç›®

```JavaScript
method: 'POST',
url: '/api/question/update'


{
    answer?: string;
    content?: string;
    id?: number;
    judgeCase?: Array<JudgeCase>;
    judgeConfig?: JudgeConfig;
    tags?: Array<string>;
    title?: string;
};
```

### è·å–é¢˜ç›®è¯¦ç»†ä¿¡æ¯

```JavaScript
method: 'GET',
url: '/api/question/get',
query: {
    'id': id,
},
```

### è·å–è¿‡æ»¤åçš„é¢˜ç›®ä¿¡æ¯

```JavaScript
method: 'GET',
url: '/api/question/get/vo',
query: {
    'id': id,
},
```

### åˆ†é¡µæŸ¥è¯¢é¢˜ç›®ä¿¡æ¯

```JavaScript
method: 'POST',
url: '/api/question/list/page'

{
    answer?: string;
    content?: string;
    current?: number;
    id?: number;
    pageSize?: number;
    sortField?: string;
    sortOrder?: string;
    tags?: Array<string>;
    title?: string;
    userId?: number;
};
```

### åˆ†é¡µæŸ¥è¯¢è¿‡æ»¤åçš„é¢˜ç›®ä¿¡æ¯

```JavaScript
method: 'POST',
url: '/api/question/list/page/vo',

{
    answer?: string;
    content?: string;
    current?: number;
    id?: number;
    pageSize?: number;
    sortField?: string;
    sortOrder?: string;
    tags?: Array<string>;
    title?: string;
    userId?: number;
};
```

## ç­”æ¡ˆæäº¤

### æ–°å¢ç­”æ¡ˆæäº¤

```JavaScript
method: 'POST',
url: '/api/question/question_submit/do',

{
    code?: string;
    language?: string;
    questionId?: number;
};
```

### åˆ†é¡µæŸ¥è¯¢ç­”æ¡ˆæäº¤

```JavaScript
method: 'POST',
url: '/api/question/question_submit/list/page',

{
    current?: number;
    language?: string;
    pageSize?: number;
    questionId?: number;
    sortField?: string;
    sortOrder?: string;
    status?: number;
    userId?: number;
};
```

# éƒ¨åˆ†æ¨¡å—

## é™æµæ¨¡å—

é‡‡ç”¨æœ€åŸºç¡€çš„å›ºå®šçª—å£é™æµï¼Œä¸ºäº†è¿åˆå‰ç«¯äººå‘˜é—ç•™çš„ä»£ç ç¼ºé™·ï¼Œåœ¨ä¸€æ¬¡å¤„ç†æ—¶é—´ä¸è¶…è¿‡é™åˆ¶çš„è¯·æ±‚ç»“æŸåä¼šç›´æ¥é‡Šæ”¾é”ï¼Œé˜²æ­¢æŠ–åŠ¨çš„è¯·æ±‚æ— æ³•è¢«å¤„ç†

## èµ„æºå‹è´Ÿè½½å‡è¡¡é€»è¾‘

æ¯ä¸ªå®ä¾‹å¯¹è±¡ä¼šä»¥ç®¡ç†è¿™ä¸ªå®ä¾‹çš„ Docker æœåŠ¡å™¨ä¸Šå¯åŠ¨çš„ä»£ç æ‰§è¡Œåå°æœåŠ¡ id ä½œä¸ºå®ä¾‹åå­—çš„ä¸€éƒ¨åˆ†ï¼Œè¿™ä¸€éƒ¨åˆ†ä¹Ÿä¼šä½œä¸º Redis çš„ Sorted_Set ä¸­çš„ member å­˜å‚¨ä¸‹æ¥ï¼Œéœ€è¦æ—¶ä¼šé€‰æ‹©è´Ÿè½½æœ€å°çš„å®ä¾‹ï¼Œè¿”å›ç»™é—¨æˆ·åå°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨è·å–åˆ°è¿™ä¸ªå®ä¾‹çš„åå­—åå¯ä»¥çŸ¥é“åº”è¯¥è°ƒç”¨å“ªä¸€ä¸ªä»£ç æ‰§è¡Œåå°æœåŠ¡å™¨ï¼Œä»£ç æ‰§è¡ŒæœåŠ¡å™¨æ‹¿åˆ°è¿™ä¸ªåå­—åä¹Ÿå¯ä»¥çŸ¥é“ä½¿ç”¨ Docker æœåŠ¡å™¨ä¸­çš„å“ªä¸€ä¸ªå®ä¾‹

![img](https://h1nj7u0kkda.feishu.cn/space/api/box/stream/download/asynccode/?code=YzdiZGUwNDg3NTEwOGIzNzViZGVmYzljNzUxZTczZGNfTW9BQzh0WlJNcG5jQmVVV2lXbG1lQWtEWXRsTlV0UjhfVG9rZW46QnNZRWJNZ0F0b0M4eUZ4OXo0SWNhaXlFbktkXzE3MzM1NTc0NDY6MTczMzU2MTA0Nl9WNA)



### ç­–ç•¥é€‰æ‹©

å½“å‰ä»¥å„ä¸ªå®ä¾‹çš„ç›¸å…³èµ„æºæ¶ˆè€—ä¸ºåŸºç¡€æ¥è¿›è¡Œè´Ÿè½½ï¼Œå¼€å§‹å‡†å¤‡é‡‡ç”¨è½®è¯¢çš„æ–¹å¼ï¼Œä½†è€ƒè™‘åˆ°ç”¨æˆ·æäº¤çš„ä»£ç æ‰§è¡Œæ—¶é—´å¯èƒ½ä¸åŒï¼Œéœ€è¦è¿›ä¸€æ­¥çš„ç»†åŒ–ä¸ºä»¥å½“å‰è¿è¡Œç”¨æˆ·ä»£ç çš„è¿›ç¨‹æ•°æ¥è¿›è¡Œè´Ÿè½½ï¼Œæ‰€ä»¥é€‰æ‹©å®ç°äº† Dubbo æ¡†æ¶ä¸‹çš„ä¸€ä¸ª AbstractLoadBalance ç±»ï¼Œå»é€‰æ‹©å‡ºå½“å‰è¿è¡Œç€æœ€å°‘è¿›ç¨‹çš„å®ä¾‹ï¼Œç„¶åå¯¹è½®è¯¢ç­–ç•¥å’Œèµ„æºè´Ÿè½½ç­–ç•¥è¿›è¡Œäº†åŸºç¡€çš„æµ‹è¯•ï¼Œç»“æœå¦‚ä¸‹

#### æµ‹è¯•ä»£ç 

äºŒåä¸ªçº¿ç¨‹æ¯ä¸ªæ¯éš” 0.5 ç§’å‘é€ä¸€æ¬¡è¯·æ±‚

```SQL
package com.whut.onlinejudge.backgrounddoor;

import cn.hutool.http.HttpRequest;
import cn.hutool.http.HttpResponse;

import java.nio.charset.StandardCharsets;

/**
 * @author liuqiao
 * @since 2024-12-04
 */
public class ApiTest {
    public static void main(String[] args) {
        for (int i = 0; i < 20; i++) {
            try {
                Thread.sleep(500);
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
            new Thread(() -> {
                while (true) {
                    HttpResponse response = HttpRequest
                            .post("http://localhost:8101/api/answer_submission/do")
                            .header("token", "738b7daf6e2bae47113a2fbf8f8fad96")
                            .header("User-Agent", "Apifox/1.0.0 (https://apifox.com)")
                            .header("Content-Type", "application/json")
                            .header("Accept", "*/*")
                            .header("Host", "localhost:8101")
                            .header("Connection", "keep-alive")
                            .body("{\n" +
                                    "    \"language\": \"JAVA\",\n" +
                                    "    \"questionId\": \"1863821439531016194\",\n" +
                                    "    \"submittedCode\": \"import java.util.Random;  public class Solution {      public int add(int a, int b) {         System.out.println(\\\"a = \\\" + a);         System.out.println(\\\"b = \\\" + b);         try {             Thread.sleep(new Random().nextInt(10) * 200L);         } catch (InterruptedException e) {             throw new RuntimeException(e);         }         return a + b;     } } \\n\"\n" +
                                    "}")
                            .execute();

                    System.out.println(new String(response.bodyBytes(), StandardCharsets.UTF_8));
                    try {
                        Thread.sleep(500);
                    } catch (InterruptedException e) {
                        throw new RuntimeException(e);
                    }
                }
            }).start();
        }
    }
}
```

#### è½®è¯¢å‹

![img](https://h1nj7u0kkda.feishu.cn/space/api/box/stream/download/asynccode/?code=YTRkNjRmOTQ3NDU4M2YwODZkODQ5NGNlZThmYzcxY2VfZFNwNG96VkZPS2JrNDdxTm9CME1vSHRhWU5mWkpkV3BfVG9rZW46UEowY2JRbHcwb1NwRlN4eEx1V2M5ckxubnRlXzE3MzM1NTc0NDY6MTczMzU2MTA0Nl9WNA)

![img](https://h1nj7u0kkda.feishu.cn/space/api/box/stream/download/asynccode/?code=NjlhM2RlMzU0ZDdjOTI2YmQ0YTRjN2QyZGRhZmI1ODJfYjI3VTI2cmxnNWdoQWE3V3BzRDI3VDhIcVVwQk53dWpfVG9rZW46RExGa2Jadjl1b1VhNUF4aFJ0c2NxQXhZbkdRXzE3MzM1NTc0NDY6MTczMzU2MTA0Nl9WNA)

![img](https://h1nj7u0kkda.feishu.cn/space/api/box/stream/download/asynccode/?code=NzZiNGZjYjhlZWVjYTMxNTBmMGNlZDk0MjY3ZmZlZjZfdndTTG16eGVWbm9jYndaNjl3czJwYU80V2tRVm1pemFfVG9rZW46SHh6aGJOcU90bzNPZ3R4a0tjNmN1ZEZjblplXzE3MzM1NTc0NDY6MTczMzU2MTA0Nl9WNA)

![img](https://h1nj7u0kkda.feishu.cn/space/api/box/stream/download/asynccode/?code=ZGIyODViZTE3ZDBlYzMzZmUxZGQwMzUxZTZiY2E5ZmVfM2VTYmhqTzFQODNYcVNqWGVXQ3p4enBoOUZMVlMyQVJfVG9rZW46R3oxaGJVb3E3b1U1UTZ4eFRDemNnaW54bnFmXzE3MzM1NTc0NDY6MTczMzU2MTA0Nl9WNA)

#### èµ„æºè´Ÿè½½å‹

![img](https://h1nj7u0kkda.feishu.cn/space/api/box/stream/download/asynccode/?code=Y2FlMDAzOWI5YzY5ZWM5YjQyMTBiNTQ3ZTNmYzY0ZmNfZ3V5VUNsMEE3T3BLRGx6OXhOQWFqdHZoajgwVXhwZlpfVG9rZW46SFZtdmJyT0xUbzNTcVB4OGFFdWNTd3o2bmZjXzE3MzM1NTc0NDY6MTczMzU2MTA0Nl9WNA)

![img](https://h1nj7u0kkda.feishu.cn/space/api/box/stream/download/asynccode/?code=YzNkYjdjNDdjZjhiZjQzOGY3ODcyOThhMGE2YzRlNDNfY3FlSllmaHUzZ0hxcW8wN2Rid1VSVkpBRXlHNFgwN0JfVG9rZW46QnNzOGJZeE9vb082djJ4dTBsWmNPREJJbmlnXzE3MzM1NTc0NDY6MTczMzU2MTA0Nl9WNA)

![img](https://h1nj7u0kkda.feishu.cn/space/api/box/stream/download/asynccode/?code=MWZhOWIxMDFkNjhjNTFkYzllNGIzNWEzMjA3NTEwOWNfeHVQTElXbmdzTzNYTGpKNFRKdWpxR0tLcVc2aGZnNHhfVG9rZW46Q2lDaGJTY2FYb1NzdFR4U1V2YWN1NXBabjBkXzE3MzM1NTc0NDY6MTczMzU2MTA0Nl9WNA)

![img](https://h1nj7u0kkda.feishu.cn/space/api/box/stream/download/asynccode/?code=NzFiMTY2NTY1ZGM2Y2YxZGUwNzVjOWQ2NmVmOGIzMTRfRzJmQkw0QnFuSFV4Nno2S3FqeEs5b0I5dlhKcFk4b2NfVG9rZW46S0NWaGJrbEFwb2RGN2t4SG9xN2NlaE9kblNnXzE3MzM1NTc0NDY6MTczMzU2MTA0Nl9WNA)

![img](https://h1nj7u0kkda.feishu.cn/space/api/box/stream/download/asynccode/?code=MTA1NjI0NDE1NTRhMGI3NTk0OTdlYWNkZDc2ZTk0MTJfSlpRcUxYbnhvamJsaHczRERINENzTWx6cTJZNTVERmJfVG9rZW46SjBwYmJ3WTR3b3IwenR4NkZGNWNqdnQ4bnNmXzE3MzM1NTc0NDY6MTczMzU2MTA0Nl9WNA)

#### ç»“è®º

èµ„æºè´Ÿè½½å‹çš„æ¯ä¸ªå®ä¾‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­è¿è¡Œç”¨æˆ·ä»£ç çš„æ—¶é—´åˆ†å¸ƒæ¯”è½®è¯¢å‹åˆ†å¸ƒæ›´åŠ å‡åŒ€ï¼Œæ–¹å·®ï¼Œæå·®ä¹Ÿæ›´å°

### ç«äº‰é¥¥é¥¿è§£å†³

æ ¹æ® sorted set çš„æ’åºç»“æœæ¥è·å–å½“å‰æœ€åˆé€‚çš„å®ä¾‹ä¼šå­˜åœ¨é—®é¢˜

sorted set ä¸ä»…ä¼šæ ¹æ® socre æ’åºï¼Œè¿˜ä¼šæ ¹æ® member æœ¬èº«çš„å­—å…¸åºæ’åºï¼Œåœ¨ç›¸åŒçš„ score æƒ…å†µä¸‹ï¼Œå­—å…¸åºæ›´å°çš„ member æœ‰å¤©ç„¶çš„ä¼˜å…ˆçº§ï¼Œå¯¼è‡´è´Ÿè½½ä¼šå‘å­—å…¸åºæ›´å°çš„ member å®ä¾‹å€¾æ–œ

#### ç¬¬ä¸€ç‰ˆ

```SQL
local member = redis.call('zrange', KEYS[1], 0, 0)

if member == nil then
    return -1
end

redis.call('zincrby', KEYS[1], 1, member[1])
return member[1]
```

#### ç¬¬äºŒç‰ˆ

```SQL
local key = KEYS[1]
local minScore = redis.call('zrange', key, 0, 0, 'withscores')[2]
local index = math.floor(ARGV[1] * redis.call('zcount', key, minScore, minScore))
local res = redis.call('zrange', key, index, index)[1]
redis.call('zincrby', key, 1, res)
return res
```

## Dubbo æ³¨å†Œä¸­å¿ƒé€‰æ‹©

### Redis

è´Ÿè½½å‡è¡¡çš„æ•°æ®æ¥æºä¸º Redisï¼Œåœ¨é…ç½®éš¾åº¦ç›¸åŒçš„æƒ…å†µä¸‹é€‰æ‹© Redis å¯ä»¥å‡å°‘é¡¹ç›®ä¸­ä¸­é—´ä»¶çš„æ•°é‡ï¼Œç®€åŒ–å¼€å‘éš¾åº¦ï¼Œä½†æ˜¯æµ‹è¯•åå‘ç°éå¸¸ä¸¥é‡çš„é—®é¢˜ï¼Œè¿™ç§æ³¨å†Œä¸­å¿ƒçš„æ•°æ®å­˜å‚¨æ˜¯ K-V å‹ï¼Œå•ç‹¬å€¼å•ç‹¬é”®ï¼Œæ²¡æœ‰å±‚æ¬¡ç»“æ„ï¼Œå¯¼è‡´ä¸€ä¸ª Key å­˜å‚¨çš„æ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œåœ¨æœåŠ¡çš„å‘ç°è¿‡ç¨‹ä¸­ä¼šå­˜åœ¨ BigKey é—®é¢˜ï¼Œä½†æ˜¯è¿™ä¸ª Key çš„ä½¿ç”¨é¢‘ç‡ä¸é«˜

![img](https://h1nj7u0kkda.feishu.cn/space/api/box/stream/download/asynccode/?code=NTZjZjI2NjcxODdiYmU1OTlmYThlZjE4ZWNjMGRkYTRfdEZvWHcyMkwzVDl2eGVFaVRCMTJSQ1pYbFJzek9OTHFfVG9rZW46U2NDYmJmamp4b3FhWHV4VmNidWNicEczbllkXzE3MzM1NTc0NDY6MTczMzU2MTA0Nl9WNA)

![img](https://h1nj7u0kkda.feishu.cn/space/api/box/stream/download/asynccode/?code=NTFjY2E1ZjYwNWEzYjU1MTlmNWFkZTc3NzBjODkwZWNfSDBrbVBINXh6NGZvNmRRTmtjWE5mdkhvcmJCaXpFcjlfVG9rZW46QXVEUGJJVUFRbzlMUE14QlpDS2N2WUgzbjNiXzE3MzM1NTc0NDY6MTczMzU2MTA0Nl9WNA)

### Nacos

è™½ç„¶å¢åŠ äº†ä¸€ä¸ªå•ç‹¬çš„æ³¨å†Œä¸­å¿ƒä¸­é—´ä»¶ï¼Œä½†æ˜¯ä½œä¸ºä¸ Dubbo åŒå…¬å¸äº§å“ï¼Œå…¼å®¹æ€§æ›´å¥½ï¼Œåç»­çš„é¡¹ç›®æ‰©å±•æ€§æ›´å¼º

## å®ä¾‹å¥åº·ç›‘æ§

å¯¹å®ä¾‹çš„è´Ÿè½½è®°å½•ï¼ŒçŠ¶æ€ä¿®æ”¹éƒ½æ˜¯é€šè¿‡ Dubbo ç»„ä»¶ä¸­çš„ LoadBalancer å’Œ Filter é€šè¿‡ SPI åŠ è½½å®ç°

è´Ÿè½½å‡è¡¡å™¨é€‰æ‹©çš„å®ä¾‹æœåŠ¡è°ƒç”¨å¤±è´¥åä¼šåœ¨ Redis ä¸­å¢åŠ å¤±è´¥çš„æ¬¡æ•°ï¼Œå½“æ¬¡æ•°è¾¾åˆ°ä¸´ç•Œå€¼æ—¶ä¼šå°†è¯¥å®ä¾‹ ID å­˜å…¥å¾…ä¸‹çº¿çš„ Redis set ä¸­ï¼Œç›‘æ§æœåŠ¡ä¼šå®šæ—¶è¯»å–è¿™ä¸ª setï¼Œå†æ¬¡å°è¯•è°ƒç”¨ï¼Œå¦‚æœä»»ç„¶å¤±è´¥åˆ™ç›´æ¥ä¸‹çº¿ï¼ŒæˆåŠŸåˆ™å‡å°‘å¤±è´¥æ¬¡æ•°ï¼Œå½“æ¬¡æ•°å°äºç­‰äºä¸´ç•Œå€¼æ—¶ä¼šæ¢å¤ä¸Šçº¿èŠ‚ç‚¹

ä¸‹çº¿çš„èŠ‚ç‚¹ä¿¡æ¯ä¼šç¼“å­˜åˆ°æœ¬åœ°ç›‘æ§æœåŠ¡å™¨ï¼Œå®šæ—¶å»æ£€æµ‹å®ä¾‹æœåŠ¡æ˜¯å¦ä¸Šçº¿ï¼Œå½“æ£€æµ‹é€šè¿‡æ—¶åˆ™æ¢å¤èŠ‚ç‚¹çŠ¶æ€

### å¢åŠ å¤±è´¥æ¬¡æ•°ä»£ç 

```SQL
--- å¼‚å¸¸æ¬¡æ•°åŠ ä¸€
if redis.call('INCR', KEY[1]) == ARGV[3] + 1 then
    --- å¼‚å¸¸æ¬¡æ•°è¶…è¿‡é¢„å®šå€¼ åŠ å…¥èŠ‚ç‚¹åˆ°å¾…ä¸‹çº¿èŠ‚ç‚¹
    redis.call('SADD', KEY[2], ARGV[1])
end

--- åˆ·æ–° key è¶…æ—¶æ—¶é—´
redis.call('EXPIRE', KEY[1], ARGV[2])
```

### ä¸‹çº¿èŠ‚ç‚¹ä»£ç 

```SQL
--- è·å–å¯¹åº”æƒé‡
local score = redis.call('ZMSCORE', KEY[1], ARGV[1])[1]
if score == nil then
    return -1
end

--- æ ¡éªŒæƒé‡å¤§å°
if score >= ARGV[2] then
    return
end

--- å¢åŠ æƒé‡
redis.call('ZINCRBY', KEY[1], ARGV[2], ARGV[1])

--- åˆ é™¤å¾…ä¸‹çº¿ set ä¸­çš„ä¿¡æ¯
redis.call('SREM', KEY[2], ARGV[1])
```

### å‡å°‘å¤±è´¥æ¬¡æ•°ä»£ç 

```SQL
--- é™ä½å¤±è´¥æ¬¡æ•°
local failTime = redis.call('GET', KEY[1])
if failTime == nil then
    return -1
end

--- è®¡ç®—å‡ºé™ä½åçš„å¤±è´¥æ¬¡æ•°
if failTime >= 2 * ARGV[1] then
    failTime = failTime / 2
else
    failTime = failTime - 1
end

if failTime > ARGV[1] then
    --- æ›´æ–°æ¬¡æ•°ç¼“å­˜
    redis.call('SETEX', KEY[1], ARGV[2], failTime)
    return 1
end

--- èŠ‚ç‚¹æ¢å¤

redis.call('DEL', KEY[1])

--- è·å–å¯¹åº”æƒé‡
local score = redis.call('ZMSCORE', KEY[2], ARGV[3])[1]
if score == nil then
    return -1
end

--- æ ¡éªŒæƒé‡å¤§å°
if score < ARGV[4] then
    return 1
end

--- é™ä½æƒé‡
redis.call('ZINCRBY', KEY[2], -ARGV[4], ARGV[3])
```

### ä¸Šçº¿èŠ‚ç‚¹ä»£ç 

```SQL
--- è·å–å¯¹åº”æƒé‡
local score = redis.call('ZMSCORE', KEY[1], ARGV[1])[1]
if score == nil then
    return -1
end

--- æ ¡éªŒæƒé‡å¤§å°
if score < ARGV[2] then
    return
end

--- é™ä½æƒé‡
redis.call('ZINCRBY', KEY[1], -ARGV[2], ARGV[1])
```

## æ ¸å¿ƒä»£ç æ¨¡å¼æ ·æ¿

### å¼•å¯¼ä»£ç 

```SQL
/**
 * @author liuqiao
 * @since 2024-12-02
 */
public class Main {

    private static int memoryLimit;

    private static int timeLimit;

    private static final Runtime runtime = Runtime.getRuntime();

    private static long startMemory;

    private static long startTime;

    /**
     * æ£€æŸ¥å½“å‰çš„å†…å­˜æ¶ˆè€—æ˜¯å¦å¤§äºæœ€å¤§é™åˆ¶å†…å­˜ï¼Œå½“å¤§äºæœ€å¤§é™åˆ¶å†…å­˜æ—¶ä¼šè¾“å‡ºç›¸å…³çš„æç¤º
     */
    private static boolean checkMemory() {
        if ((startMemory - runtime.freeMemory()) / 1024 / 1024 > memoryLimit) {
            // å†…å­˜æº¢å‡º
            System.out.println("å†…å­˜æº¢å‡º");
            System.out.println(false);
            System.out.println(false);
            return false;
        }
        return true;
    }

    /**
     * æ£€æŸ¥å½“å‰çš„æ—¶é—´æ¶ˆè€—æ˜¯å¦å¤§äºæœ€å¤§é™åˆ¶æ—¶é—´ï¼Œå½“å¤§äºæœ€å¤§é™åˆ¶æ—¶é—´æ—¶ä¼šè¾“å‡ºç›¸å…³çš„æç¤º
     */
    private static boolean checkTime() {
        if ((System.currentTimeMillis() - startTime) / 1000 > timeLimit) {
            // è¿è¡Œè¶…æ—¶
            System.out.println("è¿è¡Œè¶…æ—¶");
            System.out.println(false);
            System.out.println(false);
            return false;
        }
        return true;
    }

    /**
     * å½“å‡ºç°å¼‚å¸¸æ—¶è¾“å‡ºç›¸å…³æç¤º
     */
    private static void occurException(Throwable e) {
        // å‡ºç°å¼‚å¸¸
        System.out.println(e);
        System.out.println(true);
        System.out.println(false);
    }

    /**
     * å½“ç»“æœä¸ç¬¦åˆé¢„æœŸæ—¶è¾“å‡ºç›¸å…³æç¤º
     *
     * è¿™ä¸ªæ–¹æ³•å› è¯¥ç”±é¢˜ç›®æä¾›è€…è‡ªå®šä¹‰
     */
    private static boolean checkResult(int src, int dent) {
        if (src != dent) {
            // è¿”å›é”™è¯¯
            System.out.println(false);
            System.out.println(false);
        }
        return true;
    }

    /**
     * æµ‹è¯•é€šè¿‡æ—¶è¾“å‡ºç›¸å…³çš„å†…å­˜æ¶ˆè€—å’Œæ—¶é—´æ¶ˆè€—
     */
    private static void pass(int caseNumber) {
        System.out.println((startMemory - runtime.freeMemory()) / 1024 / 1024 / caseNumber);
        System.out.println((System.currentTimeMillis() - startTime) / caseNumber);
        System.out.println(true);
    }

    public static void main(String[] args) {
        // å›ºå®š
        memoryLimit = Integer.parseInt(args[0]);
        timeLimit = Integer.parseInt(args[1]);
        final int caseNumber = Integer.parseInt(args[2]);
        final Solution solution = new Solution();

        // å˜åŒ–
        final int[] a = new int[caseNumber], b = new int[caseNumber], c = new int[caseNumber];
        for (int i = 0; i < caseNumber; i++) {
            a[i] = Integer.parseInt(args[3 * i + 3]);
            b[i] = Integer.parseInt(args[3 * i + 4]);
            c[i] = Integer.parseInt(args[3 * i + 5]);
        }

        startTime = System.currentTimeMillis();
        startMemory = runtime.freeMemory();
        try {
            for (int i = 0; i < caseNumber; i++) {
                if (!checkResult(solution.add(a[i], b[i]), c[i]))
                    return;

                if (!checkMemory())
                    return;

                if (!checkTime())
                    return;
            }
        } catch (Throwable e) {
            occurException(e);
            return;
        }

        // é€šè¿‡
        pass(caseNumber);
    }
}
```

### æµ‹è¯•ä»£ç 

```SQL
public class Solution {

    public int add(int a, int b) {
        System.out.println("a = " + a);
        System.out.println("b = " + b);
        try {
            Thread.sleep(new Random().nextInt(10) * 200L);
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
        return a + b;
    }
}
```